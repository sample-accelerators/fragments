accelerator:
  options:
    - name: packageName
      inputType: text
      defaultValue: "com.example.customerprofile"
      label: Application root package
      required: true

engine:
  merge:
    - type: Include
      patterns: [ "**/profile.html", "**/application-local.yml" ]

    - include: [ "**/OidcUserController.java", "**/WebSecurityConfiguration.java", "**/TestWebSecurityConfiguration.java" ]
      chain:
        - type: OpenRewriteRecipe
          recipe: org.openrewrite.java.ChangePackage
          options:
            oldPackageName: "'com.vmware.tap.fragments.appssoauthcodeflow'"
            newPackageName: "#packageName"

    - include: [ "pom.xml" ]
      chain:
        - type: ReplaceText
          regex:
            pattern: "(?<startOfDependencies><dependencies>)(?<existingDependencies>(?![\\s\\S]+<artifactId>thymeleaf-extras-springsecurity5</artifactId>[\\s\\S]+</dependencies>))"
            with: |
              '${startOfDependencies}
                      <dependency>
                          <groupId>org.thymeleaf.extras</groupId>
                          <artifactId>thymeleaf-extras-springsecurity5</artifactId>
                      </dependency>${existingDependencies}'
        - type: ReplaceText
          regex:
            pattern: "(?<startOfDependencies><dependencies>)(?<existingDependencies>(?![\\s\\S]+<artifactId>spring-boot-starter-thymeleaf</artifactId>[\\s\\S]+</dependencies>))"
            with: |
              '${startOfDependencies}
                      <dependency>
                          <groupId>org.springframework.boot</groupId>
                          <artifactId>spring-boot-starter-thymeleaf</artifactId>
                      </dependency>${existingDependencies}'
        - type: ReplaceText
          regex:
            pattern: "(?<startOfDependencies><dependencies>)(?<existingDependencies>(?![\\s\\S]+<artifactId>spring-boot-starter-oauth2-client</artifactId>[\\s\\S]+</dependencies>))"
            with: |
              '${startOfDependencies}
                      <!-- AppSSO/OIDC Integration -->
                      <dependency>
                          <groupId>org.springframework.boot</groupId>
                          <artifactId>spring-boot-starter-oauth2-client</artifactId>
                      </dependency>${existingDependencies}'

    - include: [ "build.gradle.kts" ]
      chain:
        - type: ReplaceText
          regex:
            pattern: "(?<startOfDependencies>dependencies \\{)(?<existingDependencies>(?![\\s\\S]+implementation(\"org.thymeleaf.extras:thymeleaf-extras-springsecurity5\")[\\s\\S]+))"
            with: |
              '${startOfDependencies}
                  implementation("org.thymeleaf.extras:thymeleaf-extras-springsecurity5")${existingDependencies}'
        - type: ReplaceText
          regex:
            pattern: "(?<startOfDependencies>dependencies \\{)(?<existingDependencies>(?![\\s\\S]+implementation\\(\"org.springframework.boot:spring-boot-starter-thymeleaf\"\\)[\\s\\S]+))"
            with: |
              '${startOfDependencies}
                  implementation("org.springframework.boot:spring-boot-starter-thymeleaf")${existingDependencies}'
        - type: ReplaceText
          regex:
            pattern: "(?<startOfDependencies>dependencies \\{)(?<existingDependencies>(?![\\s\\S]+implementation(\"org.springframework.boot:spring-boot-starter-oauth2-client\")[\\s\\S]+))"
            with: |
              '${startOfDependencies}
                  // AppSSO/OIDC Integration
                  implementation("org.springframework.boot:spring-boot-starter-oauth2-client")${existingDependencies}'
